<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="globe.ico">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./dist/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">
    <title>Asia-pacific economic data visualization</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            /* background: url('assets/img/cool-background.svg') no-repeat center center fixed; */
            background-size: cover;
        }
        .main-nav {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px;
        }

        .main-nav > div {
            margin: 0 10px;
        }
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 200px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar button {
            padding: 10px;
            font-size: 16px;
            border: none;
            background-color: #7dc2f3;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .sidebar button:hover {
            background-color: #3a4d54;
        }



        .toggle-sidebar-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #145A32;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        .toggle-sidebar-button:hover {
            background-color: #0E3D1F;
        }
    </style>

</head>

<body>
    <div class="main-nav">
        <div class="fix-globe">
            <button class="fix-globe-button" id="fix-globe-button">Reorient</button>
        </div>
        <!-- Toggle Sidebar Button -->
        <div class="toggle-sidebar" id="toggle-sidebar">
            <a href="javascript:void(0);" id="toggle-sidebar-button">
                <i class="fas fa-bars"></i>
            </a>
        </div>
        <div id="team-member">
            <a target="_blank" href="./team.html">
                <i class="fas fa-portrait"></i>
            </a>
        </div>
    </div>
    <div class="title-div">
        <h1 class="title">Asia-pacific economic data visualization</h1>
    </div>
    <div class="country-div">
        <h2 class="country" id="current"></h2>
    </div>
    <div class="globe-container">
        <canvas width="960" height="600" id="globe"></canvas>
    </div>
    <div class="cover"></div>
    <div class="instructionModal">

    </div>
    <div class="noDataModal">
        <div class="noData">
            <div>
                <p class="dataUnavailable"></p>
            </div>
        </div>
    </div>


    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button onclick="window.location.href='./countries/China/index.html'">China</button>
        <button onclick="window.location.href='./countries/Singapore/index.html'">Singapore</button>
        <button onclick="window.location.href='./countries/Japan/index.html'">Japan</button>
    </div>
    <!--在vscode中安装liver server扩展进行html展现-->
    <!-- Import D3 and TopoJSON libraries -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script type="module">
        import { countryCodes } from './src/data/countryCodes.js';
        import { Versor } from './src/scripts/versor.js';

        window.addEventListener('DOMContentLoaded', async (event) => {
            const versor = new Versor(),
                cover = d3.select('.cover');

            const toggleSidebarButton = document.getElementById('toggle-sidebar-button');
            const sidebar = document.getElementById('sidebar');

            toggleSidebarButton.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Prevent click events on sidebar buttons from hiding the sidebar
            const sidebarLinks = sidebar.querySelectorAll('a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.stopPropagation();
                });
            });

            document.addEventListener('click', (event) => {
                if (!sidebar.contains(event.target) && !toggleSidebarButton.contains(event.target)) {
                    sidebar.classList.remove('active');
                } else if (sidebar.contains(event.target) && !event.target.closest('a')) {
                    sidebar.classList.remove('active');
                }
            });

            let canvas = d3.select("canvas"),
                current = d3.select("#current"),
                context = canvas.node().getContext("2d"),
                water = { type: 'Sphere' },
                rotationDelay = 2000,
                scaleFactor = 0.9,
                degPerSec = 6,
                angles = { x: -20, y: 40, z: 0 },
                colorCountry = '#755014',
                colorBoarders = "#000",
                colorGraticule = "#ccc",
                colorLand = "#145A32",
                colorWater = "#5DADE2",
                graticule = d3.geoGraticule10(),
                lastTime = d3.now(),
                degPerMs = degPerSec / 3000,
                width, height, land, countries, countryList, countryName, autorotate, diff, rotation,
                currentCountry,
                v0, // mouse position in Cartesian coordinates at start of drag gesture.
                r0, // Projection rotation as Euler angles at start.
                q0; // Projection rotation as versor at start.

            let projection = d3.geoOrthographic()
                .scale((height - 10) / 2)
                .translate([width / 2, height / 2])
                .precision(0.1);

            let path = d3.geoPath()
                .projection(projection)
                .context(context);

            function render() {
                context.clearRect(0, 0, width, height)
                fill(water, colorWater)
                stroke(graticule, colorGraticule)
                fill(land, colorLand)
                stroke(countries, colorBoarders)
                if (currentCountry) {
                    fill(currentCountry, colorCountry)
                }
            }

            function fill(obj, color) {
                context.beginPath()
                path(obj)
                context.fillStyle = color
                context.fill()
            }

            function stroke(obj, color) {
                context.beginPath()
                path(obj)
                context.strokeStyle = color
                context.stroke()
            }

            function setAngles() {
                let rotation = projection.rotate()
                rotation[0] = angles.y
                rotation[1] = angles.x
                rotation[2] = angles.z
                projection.rotate(rotation)
            }

            function scale() {
                width = document.documentElement.clientWidth / 1.3
                height = document.documentElement.clientHeight / 1.3
                canvas.attr('width', width).attr('height', height)
                projection
                    .scale((scaleFactor * Math.min(width, height)) / 2)
                    .translate([width / 2, height / 2])
                render()
            }

            function rotate(elapsed) {
                let now = d3.now();
                diff = now - lastTime;
                if (diff < elapsed) {
                    rotation = projection.rotate();
                    rotation[0] += diff * degPerMs
                    projection.rotate(rotation)
                    render()
                }
                lastTime = now
            }

            function startRotation(delay) {
                autorotate.restart(rotate, delay || 0)
            }

            function dragstarted(e) {
                v0 = versor.cartesian(projection.invert(d3.pointer(e)));
                r0 = projection.rotate();
                q0 = versor.versor(r0);
            }

            function dragged(e) {
                let v1 = versor.cartesian(projection.rotate(r0).invert(d3.pointer(e))),
                    q1 = versor.multiply(q0, versor.delta(v0, v1)),
                    r1 = versor.rotation(q1);
                projection.rotate(r1);
                render();
            }

            function dragended(e) {
                startRotation(rotationDelay)
            }

            function enter(country) {
                let countryName = countryList.find(c => {
                    if (c !== undefined && country !== undefined) {
                        return parseInt(c.id, 10) === parseInt(country.id, 10)
                    } else {
                        return false
                    }
                })
                current.text(countryName && countryName.name || '')
                return countryName && countryName.name || ''
            }

            function leave(country) {
                current.text('')
            }

            function polygonContains(polygon, point) {
                let n = polygon.length
                let p = polygon[n - 1]
                let x = point[0], y = point[1]
                let x0 = p[0], y0 = p[1]
                let x1, y1
                let inside = false
                for (let i = 0; i < n; ++i) {
                    p = polygon[i], x1 = p[0], y1 = p[1]
                    if (((y1 > y) !== (y0 > y)) && (x < (x0 - x1) * (y - y1) / (y0 - y1) + x1)) inside = !inside
                    x0 = x1, y0 = y1
                }
                return inside
            }

            function mousemove(e) {
                let c = getCountry(e)
                if (!c) {
                    if (currentCountry) {
                        leave(currentCountry)
                        currentCountry = undefined
                        render()
                    }
                    return
                }
                if (c === currentCountry) {
                    return
                }
                currentCountry = c
                render()
                enter(c)
            }

            function getCountryCode(countryName) {
                if (countryName && Object.keys(countryCodes).includes(countryName)) {
                    let countryCode = countryCodes[countryName]
                    return countryCode
                }
            }

            function loadCountryData(event) {
                let c = getCountry(event)
                let name = enter(c)
                let countryCode = getCountryCode(name)

                if (countryCode === 'JP') {
                    window.location.href = `./countries/Japan/index.html`;
                }
                if (countryCode === 'KH') {
                    window.location.href = `./countries/Cambodia/index.html`;
                }
                if (countryCode === 'VN') {
                    window.location.href = `./countries/Vietnam/index.html`;
                }
                else {
                    alert('This functionality is currently only available for the AP.');
                }
            }

            function getCountry(event) {
                let pos = projection.invert(d3.pointer(event))
                return countries.features.find(function (f) {
                    return f.geometry.coordinates.find(function (c1) {
                        return polygonContains(c1, pos) || c1.find(function (c2) {
                            return polygonContains(c2, pos)
                        })
                    })
                })
            }

            function deleteModal(e) {
                const canvas = d3.select('#chart')
                canvas.remove()
                const modalCont = d3.select('.modalContainer')
                modalCont.remove()
                cover.style('opacity', 0).style('pointer-events', 'none')
            }

            try {
                const world = await d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
                land = topojson.feature(world, world.objects.land);
                countries = topojson.feature(world, world.objects.countries);
            } catch (e) {
                console.log(e)
            }

            try {
                const countryNames = await d3.tsv('https://gist.githubusercontent.com/mbostock/4090846/raw/07e73f3c2d21558489604a0bc434b3a5cf41a867/world-country-names.tsv')
                countryList = countryNames
            } catch (e) {
                console.log(e)
            }

            function fixGlobe(e) {
                let rotation = projection.rotate()
                rotation[0] = 40
                rotation[1] = -20
                rotation[2] = 0
                projection.rotate(rotation)
            }

            setAngles();

            canvas.call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            )
                .on("mousemove", mousemove)
                .on("click", loadCountryData)

            cover.on("click", deleteModal)
            const fixGlobeButton = document.querySelector(".fix-globe-button")
            fixGlobeButton.addEventListener("click", fixGlobe)

            const instructions = document.querySelector(".instructionModal");
            instructions.addEventListener("click", () => {
                instructions.style.opacity = '0';
                instructions.style.pointerEvents = 'none';
            })

            window.addEventListener('resize', scale);
            scale();
            autorotate = d3.timer(rotate);
        });
    </script>
</body>

</html>